
---
output:
  html_document:
    df_print: paged
  pdf_document:
    fig_caption: no
header-includes:
- \usepackage[utf8]{inputenc}
- \usepackage[T1]{fontenc}
- \usepackage{textcomp}
- \usepackage[english]{babel}
- \usepackage{dcolumn}
- \usepackage{enumitem}
- \usepackage{xcolor}
fontsize: 11pt
params:
  name: Migla Miskinyte
  date: '2021-03-15'
  description: Survival analysis
  data: folders/HMI/Migla/data/2021/March
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = T,background = '#ff9900',highlight = TRUE,comment = NA,warning = F)
```

<!-- DO NOT CHANGE: JUST CHANGE graphics path -->
\begin{minipage}[t]{0.2\textwidth}
\graphicspath{{C:/Migla/}}    
\centering\includegraphics[width=10in]{Wolbachia.png}
\end{minipage}
\begin{minipage}[t]{0.7\textwidth}
\vspace{-2.7cm}
\centering \Large \textbf{Host-microbe interactions 2020/21}\\Date: `r params$date`\\Data in: `r params$data`\\`r params$name`\\
\end{minipage}
<!-- END -->

<!-- DO NOT CHANGE -->
\textbf{DCV pricking test - `r params$description`} 
<!-- END OF DO NOT CHANGE -->

This is my first trial for DCV pricking using two different genotypes of Wolbachia (Iso and wMel) and different concentrations of virus.

\ First, all necessary packages are uploaded. Remove hashtag before running. 

```{r}
library(tidyverse)
library(coxme)
library(car)
library(emmeans)
library(here)
library(ggplot2)
library(tidyr)
library(scales)

```


Now run converter function. 

```{r}
## script of surv_converter() function
## Converts HMI survival data to long format. Output file has information on flies alive per day
# and number of flies with different status for survival analysis.

## Author: Luis Teixeira, Host-Microorganism Interactions lab
##version 1.0

# requires tidyverse library

surv_converter <- function(filename, save_table = TRUE) {
  
  #load file
  surv <- read.csv(filename, stringsAsFactors = FALSE, header = FALSE)
  
  
  # change entries using higher case in old format to lower case. These lines are only required to make this script compatible with older data files.
  #It can be eliminated in a new script and an error will be shown if old format is being used. Directly editing data file will also solve the problem.
  surv[surv == "Factors"] <- c("factors")
  surv[surv == "Days"] <- c("day")
  surv[surv == "Info"] <- c("info")
  surv[surv == "Date"] <- c("date")
  
  #find rows which separate info, factors, and survival data blocks.
  factors_row <- match("factors",surv[,1])
  day_row <- match("day",surv[,1])
  
  # Get date, last day of survival, total number of flies, names of factors
  date <- surv[match("date",surv[,1]), 2]
  lastday <- as.numeric(surv[nrow(surv), 1])
  sum_control <- sum(as.numeric(surv[day_row+1, 2:ncol(surv)]))
  factors_names <- surv[(factors_row+1):(day_row-1), 1]
  
  #print total number of flies
  print(paste(("total number of flies is "),sum_control,sep=""))
  
  # quality check #####
  
  #check some file formatting
  if (surv[1,1] != "info") {stop("There is an error in  file format")}
  if (is.na(factors_row)) {stop("There is an error in  file format, no cell with *factors*")}
  if (is.na(day_row)) {stop("There is an error in  file format, no cell with *days*")}
  
  if (day_row < factors_row) {stop("There is an error in  file format")}
  if (day_row == (factors_row+1)) {stop("There is an error in  file format - factors are not defined")}
  
  
  #print row and column number to check in case of troubleshooting
  print(paste("input file has ", nrow(surv), " rows and ", ncol(surv), " columns", sep=""))
  
  #check if number of flies increases from one day to the other
  for (j in 2:ncol(surv)) {
    for (i in (day_row+1):(nrow(surv)-1)) {
      if (as.numeric(surv[i,j]) < as.numeric(surv[i+1,j])) {
        stop(paste("Spontaneous generation of flies at day ", surv[i+1,1],", column ", j, sep=""))
      }
    }
  }
  
  #check if days start at 0 and are consecutive numbers till last day
  if (surv[day_row+1, 1] != 0) {stop("There is an error in  file format - day 0 data is not shown")}
  
  for (i in (day_row+1):(nrow(surv)-1)) {
    if ((as.numeric(surv[i+1,1]) - as.numeric(surv[i,1])) != 1 ) {
      stop(paste("There is an error in days of survival, they should be consecutive days. Check rows ", i," and ", i+1, sep=""))
    }
  }
  
  
  # transform data #####
  
  #transpose table, get column names from first row, delete first row, delete columns of "info" block and column "day"
  trans_surv <- as.data.frame(t(surv))
  colnames(trans_surv)=trans_surv[1,]
  trans_surv <- trans_surv[-1, ]
  trans_surv <- trans_surv[, -c(1:factors_row,day_row)]
  
  #convert survival data to numeric
  data_col <- ((day_row - factors_row):ncol(trans_surv))
  trans_surv[, data_col] <- sapply(trans_surv[, data_col], as.numeric)
  
  #check that each row is a unique combination of factors
  if (nrow(trans_surv) != nrow(unique(trans_surv[, factors_names]))) {
    stop("There is an error in factors specification - at least two column have the same combination of factors")
  }
  
  #transform wide to long
  trans_surv <- trans_surv %>% 
    pivot_longer(
      cols = all_of(data_col),
      names_to = "day_alive",
      values_to = "number_alive",
      values_drop_na = FALSE
    )
  
  #add date if exists
  if (!is.na(date)) {trans_surv <- add_column(trans_surv, date = date, .before = 1)}
  
  
  #make "day" and "survival" numeric
  trans_surv$day_alive <- as.numeric(trans_surv$day_alive)
  trans_surv$number_alive <- as.numeric(trans_surv$number_alive)
  
  
  #make day_status, number_status and status columns
  trans_surv <- trans_surv %>% add_column(day_status = NA, number_status = NA, status = NA)
  
  
  #get dead per day, add 1 to day with dead flies, set status for statistical analysis (1  = dead, 0 = alive (truncated at the last day))
  for (i in 1:(nrow(trans_surv))){
    if (trans_surv$day_alive[i] != lastday) {
      trans_surv$number_status[i] = trans_surv$number_alive[i] - trans_surv$number_alive[i+1]
      trans_surv$day_status[i] <- trans_surv$day_alive[i] + 1
      if (trans_surv$number_status[i] != 0) {
        trans_surv$status[i] <- 1
      }
    } else {
      trans_surv$number_status[i] = trans_surv$number_alive[i]
      trans_surv$day_status[i] = trans_surv$day_alive[i]
      if (trans_surv$number_status[i] != 0) {
        trans_surv$status[i] <- 0
      }
    }
  }
  
  
  # check if final number of flies is equal to inicial number of flies 
  if (sum(trans_surv$number_status) != sum_control) {  stop("There is an error number of flies in final table") }
  
  
  #write file
  if(save_table) {
    filename <- str_remove(filename, ".csv")
    write.table(trans_surv, file = paste(filename, "_converted.csv", sep=""), sep = ",", row.names = FALSE, col.names = TRUE)
  }
  
  #end
  return(trans_surv)
  
}

```

Check where I am?
```{r}
here::i_am("Scripts/surv_converter.R")

```
Run converter function  using the dataset. 
```{r}
converted_data <- surv_converter(here("Scripts","test_converter_data.csv"))

```


Check data format.
```{r}
head(converted_data)

```
Load converted data.

```{r}
surv_1_plot <- read.csv(here("Scripts","test_converter_data_converted.csv"), stringsAsFactors = FALSE, header = TRUE)

head(surv_1_plot)
```


Sum survival values per condition, per day, and make new column expressing this as percentage.
This gives average across vials in one condition per day, in one experiment.
The data are first grouped by all factors except "vial".
Number of flies alive in that day in all vials of those conditions are summed.
The sum of flies alive in all vials in that day in that condition is then divided by the initial total of flies (the maximum of these sums per condition).
Note - in the script below the table is first grouped by "virus", "wolbachia", and "day_alive". After the "summarise" function the last level of grouping is lost and becomes only "virus" and "wolbachia". This is useful since allows the "max" function afterwards. But be careful with order of factors in "group_by"

```{r}
surv_curves_summary <- surv_1_plot %>%
    group_by(virus, wolbachia, day_alive) %>%
    summarise(number_alive = sum(number_alive)) %>%
    mutate(surv_percentage = number_alive / max(number_alive) * 100) %>%
    ungroup()

head(surv_curves_summary)
```

Plot data.
```{r}
plot <- ggplot(data = surv_curves_summary, aes(x = day_alive, y = surv_percentage, color = wolbachia, shape = virus)) +
    geom_line(size = 0.8) +
    geom_point(size = 1.5, stroke = 0.5, fill = "white") +
    scale_color_manual(values=c("grey50", "black")) +
    scale_shape_manual(values=c(21, 19))+
    labs(x = "Days post infection", y = NULL, title = "Survival (%)")

plot
```

Plotting survival curves using survminer package.
Load library.

```{r}
library(survminer)
library(RColorBrewer)
```
```{r}
fitx <- survfit(Surv(day_status, status) ~wolbachia+virus, data = surv_1_plot, type="kaplan")
```

For color blind people palette. 

```{r}
library(RColorBrewer)
display.brewer.all(colorblindFriendly = T)
display.brewer.pal(n = 8, name = 'Paired')

# Hexadecimal color specification 
brewer.pal(n = 8, name = "Paired")
```



Now plot pretty plot.


```{r}
ggsurvplot(
  fitx,
  fun = "pct",
  data = surv_1_plot,
  size = 1.2,                 # change line size
  palette =
    c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00"),# custom color palettes color blind
  linetype = c(1,2,1,2),
  #scale_linetype_manual(values = c(1,2,1,2),
  conf.int = TRUE,          # Add confidence interval
  pval = TRUE,              # Add p-value
  #risk.table = TRUE,        # Add risk table
  #risk.table.col = "status",# Risk table color by groups
  legend.labs =
    c("wolb-,dcv-", "wolb-,dcv+","wolb+,dcv-", "wolb+,dcv+"),    # Change legend labels
  risk.table.height = 0.25, # Useful to change when you have multiple groups
  ggtheme = theme_bw()      # Change ggplot2 theme
)

```


If we need to separate strata in different factors. 

```{r}
fitx1=as.data.frame(summary(fitx, times=c(0:80))[c("surv", "time", "strata")])
```


```{r}
for(i in 1:139)
{
  fitx1$strata1[i]=strsplit(as.character(fitx1$strata[i]),',')[[1]][1]
  fitx1$strata2[i]=strsplit(as.character(fitx1$strata[i]),',')[[1]][2]
   fitx1$strata3[i]=strsplit(as.character(fitx1$strata[i]),',')[[1]][3]
}
```



Rename columns

```{r}
fitx1$wolbachia=factor(sub("wolbachia=", "", fitx1$strata1))
fitx1$virus=factor(sub("virus=", "", fitx1$strata2))
#fitx1$dilution=factor(sub("dilution=", "", KaplanMeier2$strata3))
#fitx1$background=
```



```{r}
head(fitx1)
```


```{r}
#write file
write.table(fitx1,here("DCV_KaplanMeier.csv"), sep = ",", row.names = FALSE, col.names = TRUE)
```


```{r}
##Survival plot 
rm(list=ls())
library(here)
library(survival)
data=read.csv(here("DCV_KaplanMeier.csv"))

data



```

```{r}
#Replicate A

Plot=ggplot(data, aes(x=time, y=surv)) 
Plot2=Plot + geom_line(aes(colour=strata1, linetype = strata2, alpha=strata2), size=1.5) +geom_point(aes(shape=strata1),size=3,color='darkgray')+  theme_classic() + scale_x_continuous(limits=c(0,40.5), expand = c(0,0),breaks=0:62*5) +  
  scale_y_continuous(labels=percent, limits=c(0,1.05),breaks=0:100*.2, expand = c(0,0)) + 
  xlab("Days post DCV oral infection") + ylab("") + labs (title = "Percentage of males and females alive") + 
  theme(text=element_text(size=20, face="bold", colour = "black"), panel.background = element_blank(),  axis.line = element_line(colour = "black", size = 1.5, linetype = "solid"), axis.ticks = element_line(size = 1.5), axis.text.x = element_text(face="bold", color="black"), axis.text.y = element_text(face="bold", color="black"), plot.title = element_text(hjust =-0.2, vjust=1),legend.title=element_blank()) + scale_color_manual(values = c("Darkorange","Cyan3","Darkolivegreen3","Darkgray","Black")) + scale_linetype_manual(values=c("solid", "solid"))+ scale_shape_manual(values=c(16,17)) + 
guides(color = guide_legend(override.aes = list(size = 2),order = 1)) + scale_alpha_ordinal(range = c(.1, 1))

Plot2
```


Now perform Cox analysis. First, re-format the data.


```{r}
#load file
surv_1_cox<-read.csv(here("Scripts","test_converter_data_converted.csv"), stringsAsFactors = FALSE, header = TRUE)
head(surv_1_cox)

```


```{r}
# remove columns day_alive and number_alive so that file does not become nonsensical after transformation
# make one entry per fly
surv_data_1 <- surv_1_cox %>%
  select(-c(day_alive, number_alive))  %>%
  uncount(number_status)
head(surv_data_1)

```
```{r}
#make virus and wolbachia factors
surv_data_1$virus <- as.factor(surv_data_1$virus)
surv_data_1$wolbachia <- as.factor(surv_data_1$wolbachia)

```


```{r}
#make a unique_id for each vial, so that vial 1 of one condition is not associated with vial 1 of another condition
surv_data_1 <- unite(surv_data_1, "unique_id", "date", "virus", "wolbachia", "vial", sep = "_", remove = FALSE)
head(surv_data_1)
```

```{r}
#number of rows should match number of flies in original data
nrow(surv_data_1)

```
```{r}
### Cox mixed model
model_1 = coxme::coxme(Surv(day_status, status) ~ wolbachia*virus + (1|unique_id), data = surv_data_1)
summary(model_1)

```
Same analysis with different package to compare.

```{r}
model_1a <- coxph(Surv(day_status, status) ~ wolbachia*virus + frailty(unique_id), data = surv_data_1 )

summary(model_1a)


```


Plot cox hazard ratios

```{r}
exp(coef(model_1a))
ggforest(model_1a, data=surv_1_cox)

```




```{r}
# significance of the model and interaction
model_1_anova <- car::Anova(model_1)
model_1_anova
```


There is a significant interaction between *Wolbachia* and virus

To understand better what is happening with the interaction we can compare the effect of *Wolbachia* when the virus is present or not:



```{r}
# compare the effect of Wolbachia with or without viruses
compare_wolbachia = emmeans::emmeans(model_1, pairwise~wolbachia|virus)
summary_wolb <- summary(compare_wolbachia, by=NULL, adj="holm")
summary_wolb
```

*Wolbachia* only has an effect when *DCV* is present (*p* `r r_pval(summary_wolb[["contrasts"]][["p.value"]][2])`).

We could also compare the effect of the virus when *Wolbachia* is present or not:
```{r}
# compare the effect of virus with or without Wolbachia
compare_virus = emmeans::emmeans(model_1, pairwise~virus|wolbachia)
summary_virus <- summary(compare_virus, by=NULL, adj="holm")
summary_virus
```










